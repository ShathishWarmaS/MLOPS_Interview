<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n8n MLOps Platform - Enhanced with Dataset Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }

        .demo-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 0.75rem;
            font-weight: 600;
            position: relative;
            z-index: 1000;
        }

        .app-header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .app-title h1 {
            color: #333;
            font-size: 1.5rem;
        }

        .workflow-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary { background: #4a90e2; color: white; }
        .btn-success { background: #7ed321; color: white; }
        .btn-secondary { background: #f5f5f5; color: #333; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #17a2b8; color: white; }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }

        .node-palette {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 1rem;
            overflow-y: auto;
        }

        .palette-section {
            margin-bottom: 1.5rem;
        }

        .palette-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #666;
            font-size: 0.875rem;
            text-transform: uppercase;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .palette-actions {
            display: flex;
            gap: 0.25rem;
        }

        .palette-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .palette-btn.add { background: #28a745; color: white; }
        .palette-btn.manage { background: #17a2b8; color: white; }

        .palette-btn:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }

        .node-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .node-item:hover {
            background: #e9ecef;
            border-color: #4a90e2;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .node-item:active {
            cursor: grabbing;
        }

        .node-item.custom {
            border-left: 4px solid #f39c12;
        }

        .node-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border: none;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.75rem;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .node-item:hover .node-remove {
            display: flex;
        }

        .node-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .node-info h4 {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #333;
        }

        .node-info p {
            font-size: 0.75rem;
            color: #666;
            line-height: 1.3;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: #fafbfc;
            overflow: hidden;
        }

        .canvas {
            width: 100%;
            height: 100%;
            position: relative;
            background-image: 
                radial-gradient(circle, #ddd 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .workflow-node {
            position: absolute;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            min-width: 240px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            cursor: move;
            transition: all 0.2s;
            z-index: 10;
        }

        .workflow-node:hover {
            border-color: #4a90e2;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .workflow-node.selected {
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        .workflow-node.executing {
            border-color: #f39c12;
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.3);
            animation: pulse 2s infinite;
        }

        .node-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .node-header .node-icon {
            width: 32px;
            height: 32px;
            font-size: 1rem;
        }

        .node-content {
            flex: 1;
        }

        .node-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: #333;
        }

        .node-type {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
        }

        .node-body {
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
        }

        .node-preview {
            max-height: 120px;
            overflow-y: auto;
            margin-top: 0.5rem;
        }

        .data-preview {
            display: grid;
            gap: 0.25rem;
            font-family: monospace;
            font-size: 0.7rem;
        }

        .data-row {
            padding: 0.25rem 0.5rem;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #4a90e2;
        }

        .node-status {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6c757d;
            border: 2px solid white;
        }

        .node-status.idle { background: #6c757d; }
        .node-status.ready { background: #28a745; }
        .node-status.running { background: #ffc107; animation: pulse 1.5s infinite; }
        .node-status.completed { background: #17a2b8; }
        .node-status.error { background: #dc3545; }

        /* Connection Handles */
        .connection-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #666;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 20;
        }

        .connection-handle:hover {
            border-color: #4a90e2;
            background: #4a90e2;
            transform: scale(1.2);
        }

        .input-handle {
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .output-handle {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-handle.highlight {
            border-color: #7ed321;
            background: #7ed321;
            transform: scale(1.3);
        }

        /* Connection Lines */
        .connection-line {
            stroke: #4a90e2;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .connection-line:hover {
            stroke: #7ed321;
            stroke-width: 3;
        }

        .connection-line.temp {
            stroke: #ffc107;
            stroke-dasharray: 5,5;
        }

        .connection-line.active {
            stroke: #f39c12;
            stroke-width: 3;
            animation: flow 2s linear infinite;
        }

        /* Data Visualization Panel */
        .data-viz-panel {
            width: 350px;
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .viz-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .viz-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .viz-section {
            margin-bottom: 1.5rem;
        }

        .viz-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 0.875rem;
        }

        .chart-container {
            height: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4a90e2;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: #f0f0f0;
        }

        /* Dataset Management */
        .dataset-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .dataset-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
            transition: all 0.2s;
        }

        .dataset-card:hover {
            border-color: #4a90e2;
            background: white;
        }

        .dataset-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .dataset-name {
            font-weight: 600;
            color: #333;
        }

        .dataset-actions {
            display: flex;
            gap: 0.5rem;
        }

        .dataset-stats {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .dataset-preview {
            font-size: 0.75rem;
            font-family: monospace;
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            max-height: 100px;
            overflow-y: auto;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
            font-size: 0.875rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: monospace;
        }

        /* File upload */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload:hover {
            border-color: #4a90e2;
            background: #f8f9fa;
        }

        .file-upload.dragover {
            border-color: #7ed321;
            background: #f0fff0;
        }

        /* Status Panel */
        .status-panel {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .status-info {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: #666;
        }

        .execution-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .execution-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .execution-dot.running {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        .help-text {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
            max-width: 80%;
            text-align: center;
        }

        .help-text.show {
            opacity: 1;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90e2, #7ed321);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Data table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            margin-top: 1rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Animations */
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes flow {
            0% { stroke-dasharray: 5 5; stroke-dashoffset: 0; }
            100% { stroke-dasharray: 5 5; stroke-dashoffset: 10; }
        }
    </style>
</head>
<body>
    <div class="demo-banner">
        üöÄ n8n MLOps Platform - Enhanced with Complete Dataset Management & Custom Data Sources
    </div>

    <div class="app-header">
        <div class="app-title">
            <h1>üîÑ n8n MLOps Platform</h1>
            <span style="background: #e3f2fd; color: #1976d2; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                Enhanced with Dataset Management
            </span>
        </div>
        <div class="workflow-controls">
            <button class="btn btn-info" onclick="showDatasetManager()">
                üìö Manage Datasets
            </button>
            <button class="btn btn-warning" onclick="loadSamplePipeline()">
                üìä Load Sample Pipeline
            </button>
            <button class="btn btn-secondary" onclick="clearAll()">
                üóëÔ∏è Clear All
            </button>
            <button class="btn btn-primary" onclick="saveWorkflow()">
                üíæ Save
            </button>
            <button class="btn btn-success" onclick="executeWorkflow()">
                ‚ñ∂Ô∏è Execute Pipeline
            </button>
        </div>
    </div>

    <div class="main-container">
        <!-- Node Palette -->
        <div class="node-palette">
            <div class="palette-section">
                <div class="palette-title">
                    üìä Data Sources
                    <div class="palette-actions">
                        <button class="palette-btn add" onclick="showAddDatasetModal()" title="Add Dataset">+</button>
                        <button class="palette-btn manage" onclick="showDatasetManager()" title="Manage Datasets">‚öô</button>
                    </div>
                </div>
                <div id="dataSources">
                    <!-- Data source nodes will be populated here -->
                </div>
            </div>

            <div class="palette-section">
                <div class="palette-title">üîß Data Processing</div>
                <div class="node-item" draggable="true" data-node-type="dataValidation">
                    <div class="node-icon" style="background: #ffc107;">‚úÖ</div>
                    <div class="node-info">
                        <h4>Data Validation</h4>
                        <p>Check data quality and completeness</p>
                    </div>
                </div>
                <div class="node-item" draggable="true" data-node-type="dataCleaning">
                    <div class="node-icon" style="background: #20c997;">üßπ</div>
                    <div class="node-info">
                        <h4>Data Cleaning</h4>
                        <p>Remove duplicates, handle missing values</p>
                    </div>
                </div>
                <div class="node-item" draggable="true" data-node-type="featureEngineering">
                    <div class="node-icon" style="background: #6f42c1;">üîß</div>
                    <div class="node-info">
                        <h4>Feature Engineering</h4>
                        <p>Create and transform features</p>
                    </div>
                </div>
                <div class="node-item" draggable="true" data-node-type="dataJoin">
                    <div class="node-icon" style="background: #fd7e14;">üîó</div>
                    <div class="node-info">
                        <h4>Data Join</h4>
                        <p>Merge multiple data sources</p>
                    </div>
                </div>
            </div>

            <div class="palette-section">
                <div class="palette-title">üß† Machine Learning</div>
                <div class="node-item" draggable="true" data-node-type="modelTraining">
                    <div class="node-icon" style="background: #dc3545;">üß†</div>
                    <div class="node-info">
                        <h4>Model Training</h4>
                        <p>Train ML models (RF, XGBoost, NN)</p>
                    </div>
                </div>
                <div class="node-item" draggable="true" data-node-type="modelEvaluation">
                    <div class="node-icon" style="background: #17a2b8;">üìà</div>
                    <div class="node-info">
                        <h4>Model Evaluation</h4>
                        <p>Evaluate model performance</p>
                    </div>
                </div>
                <div class="node-item" draggable="true" data-node-type="hyperparameterTuning">
                    <div class="node-icon" style="background: #e83e8c;">‚öôÔ∏è</div>
                    <div class="node-info">
                        <h4>Hyperparameter Tuning</h4>
                        <p>Optimize model parameters</p>
                    </div>
                </div>
            </div>

            <div class="palette-section">
                <div class="palette-title">üöÄ Deployment & Monitoring</div>
                <div class="node-item" draggable="true" data-node-type="modelDeployment">
                    <div class="node-icon" style="background: #fd7e14;">üöÄ</div>
                    <div class="node-info">
                        <h4>Model Deployment</h4>
                        <p>Deploy to production endpoints</p>
                    </div>
                </div>
                <div class="node-item" draggable="true" data-node-type="monitoring">
                    <div class="node-icon" style="background: #20c997;">üìä</div>
                    <div class="node-info">
                        <h4>Model Monitoring</h4>
                        <p>Track performance & drift</p>
                    </div>
                </div>
                <div class="node-item" draggable="true" data-node-type="alerting">
                    <div class="node-icon" style="background: #dc3545;">üö®</div>
                    <div class="node-info">
                        <h4>Alerting</h4>
                        <p>Send alerts on anomalies</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas -->
        <div class="canvas-container">
            <div class="help-text" id="helpText">
                Use the Dataset Manager to add/remove datasets, then drag them to build your ML pipeline!
            </div>
            <div class="canvas" id="canvas">
                <svg id="connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#4a90e2" />
                        </marker>
                    </defs>
                </svg>
            </div>

            <div class="status-panel">
                <div class="status-info">
                    <span>Nodes: <strong id="nodeCount">0</strong></span>
                    <span>Connections: <strong id="connectionCount">0</strong></span>
                    <span>Datasets: <strong id="datasetCount">4</strong></span>
                    <span>Pipeline Progress: <strong id="pipelineProgress">0%</strong></span>
                </div>
                <div class="execution-status">
                    <div class="execution-dot" id="executionStatus"></div>
                    <span id="executionText">Ready</span>
                </div>
            </div>
        </div>

        <!-- Data Visualization Panel -->
        <div class="data-viz-panel">
            <div class="viz-header">
                <h3>üìä Data Insights & Pipeline Results</h3>
            </div>
            <div class="viz-content">
                <div class="viz-section">
                    <div class="viz-title">üìà Current Dataset Overview</div>
                    <div id="datasetStats" class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="recordCount">-</div>
                            <div class="stat-label">Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="featureCount">-</div>
                            <div class="stat-label">Features</div>
                        </div>
                    </div>
                </div>

                <div class="viz-section">
                    <div class="viz-title">üéØ Model Performance</div>
                    <div class="chart-container">
                        <canvas id="performanceChart" width="300" height="150"></canvas>
                    </div>
                </div>

                <div class="viz-section">
                    <div class="viz-title">‚ö° Pipeline Execution</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div id="executionLog" style="font-size: 0.75rem; color: #666; margin-top: 0.5rem; max-height: 100px; overflow-y: auto;">
                        Ready to execute pipeline...
                    </div>
                </div>

                <div class="viz-section">
                    <div class="viz-title">üìä Data Preview</div>
                    <div id="dataPreview" style="font-size: 0.7rem; max-height: 150px; overflow-y: auto; background: #f8f9fa; padding: 0.5rem; border-radius: 4px;">
                        Select a data source to preview...
                    </div>
                </div>

                <div class="viz-section">
                    <button class="btn btn-primary" onclick="showDataModal()" style="width: 100%;">
                        üîç View Full Dataset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dataset Manager Modal -->
    <div class="modal" id="datasetManagerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìö Dataset Manager</h3>
                <button class="close-btn" onclick="closeDatasetManager()">&times;</button>
            </div>
            <div>
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-success" onclick="showAddDatasetModal()">‚ûï Add New Dataset</button>
                    <button class="btn btn-warning" onclick="loadDefaultDatasets()">üîÑ Restore Defaults</button>
                </div>
                <div id="datasetManagerContent" class="dataset-list">
                    <!-- Dataset cards will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Dataset Modal -->
    <div class="modal" id="addDatasetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ûï Add New Dataset</h3>
                <button class="close-btn" onclick="closeAddDatasetModal()">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Dataset Name</label>
                    <input type="text" id="datasetName" class="form-input" placeholder="e.g., Customer Churn Data">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="datasetDescription" class="form-input" placeholder="Brief description of the dataset">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Icon Emoji</label>
                    <input type="text" id="datasetIcon" class="form-input" placeholder="üìä" maxlength="2">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Color</label>
                    <select id="datasetColor" class="form-select">
                        <option value="#28a745">Green</option>
                        <option value="#dc3545">Red</option>
                        <option value="#17a2b8">Blue</option>
                        <option value="#ffc107">Yellow</option>
                        <option value="#6f42c1">Purple</option>
                        <option value="#fd7e14">Orange</option>
                        <option value="#20c997">Teal</option>
                        <option value="#e83e8c">Pink</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Data Input Method</label>
                    <select id="dataInputMethod" class="form-select" onchange="toggleDataInput()">
                        <option value="json">Manual JSON Input</option>
                        <option value="csv">CSV Upload</option>
                        <option value="generate">Generate Sample Data</option>
                    </select>
                </div>
                
                <div id="jsonInput" class="form-group">
                    <label class="form-label">Dataset JSON (Array of objects)</label>
                    <textarea id="datasetJson" class="form-textarea" placeholder='[{"id": 1, "name": "John", "age": 30}, {"id": 2, "name": "Jane", "age": 25}]'></textarea>
                </div>
                
                <div id="csvInput" class="form-group" style="display: none;">
                    <label class="form-label">Upload CSV File</label>
                    <div class="file-upload" id="csvUpload">
                        <p>üìÅ Drag and drop CSV file here or click to browse</p>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                    </div>
                </div>
                
                <div id="generateInput" class="form-group" style="display: none;">
                    <label class="form-label">Sample Data Type</label>
                    <select id="sampleDataType" class="form-select">
                        <option value="customers">Customer Data</option>
                        <option value="sales">Sales Transactions</option>
                        <option value="products">Product Catalog</option>
                        <option value="users">User Behavior</option>
                    </select>
                    <label class="form-label" style="margin-top: 0.5rem;">Number of Records</label>
                    <input type="number" id="sampleRecordCount" class="form-input" value="100" min="10" max="10000">
                </div>
                
                <div style="margin-top: 1.5rem; text-align: right;">
                    <button class="btn btn-secondary" onclick="closeAddDatasetModal()">Cancel</button>
                    <button class="btn btn-success" onclick="createDataset()">Create Dataset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Viewer Modal -->
    <div class="modal" id="dataModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìä Dataset Viewer</h3>
                <button class="close-btn" onclick="closeDataModal()">&times;</button>
            </div>
            <div id="modalDataContent">
                <p>Loading data...</p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let nodes = [];
        let connections = [];
        let selectedNode = null;
        let nodeCounter = 0;
        let isConnecting = false;
        let connectionStart = null;
        let tempConnection = null;
        let currentDataset = null;
        let performanceChart = null;
        let executionInProgress = false;
        let customDatasets = [];

        // Sample datasets (defaults)
        const defaultDatasets = {
            customerData: {
                id: 'customerData',
                name: "Customer Demographics",
                description: "Customer data with demographics",
                icon: 'üë•',
                color: '#28a745',
                records: 1000,
                features: 8,
                isDefault: true,
                data: [
                    { id: 1, age: 34, income: 65000, city: "New York", segment: "Premium", lifetime_value: 2500, churn_risk: 0.2 },
                    { id: 2, age: 28, income: 45000, city: "Chicago", segment: "Standard", lifetime_value: 1200, churn_risk: 0.4 },
                    { id: 3, age: 42, income: 85000, city: "San Francisco", segment: "Premium", lifetime_value: 3200, churn_risk: 0.1 },
                    { id: 4, age: 31, income: 55000, city: "Austin", segment: "Standard", lifetime_value: 1800, churn_risk: 0.3 },
                    { id: 5, age: 25, income: 38000, city: "Denver", segment: "Basic", lifetime_value: 800, churn_risk: 0.6 }
                ]
            },
            fraudData: {
                id: 'fraudData',
                name: "Fraud Detection Dataset",
                description: "Transaction data with fraud labels",
                icon: 'üö´',
                color: '#dc3545',
                records: 5000,
                features: 10,
                isDefault: true,
                data: [
                    { transaction_id: "T001", amount: 1250.50, merchant: "Amazon", time: "14:30", location_risk: 0.1, is_fraud: 0 },
                    { transaction_id: "T002", amount: 2800.00, merchant: "Unknown", time: "02:15", location_risk: 0.8, is_fraud: 1 },
                    { transaction_id: "T003", amount: 85.99, merchant: "Starbucks", time: "08:45", location_risk: 0.0, is_fraud: 0 },
                    { transaction_id: "T004", amount: 4500.00, merchant: "Cash Advance", time: "23:55", location_risk: 0.9, is_fraud: 1 },
                    { transaction_id: "T005", amount: 156.78, merchant: "Walmart", time: "16:20", location_risk: 0.1, is_fraud: 0 }
                ]
            },
            salesData: {
                id: 'salesData',
                name: "Product Sales Data",
                description: "Product sales and revenue data",
                icon: 'üí∞',
                color: '#17a2b8',
                records: 2500,
                features: 7,
                isDefault: true,
                data: [
                    { product_id: "P001", product_name: "Laptop Pro", category: "Electronics", price: 1299.99, units_sold: 45, revenue: 58499.55 },
                    { product_id: "P002", product_name: "Wireless Mouse", category: "Accessories", price: 29.99, units_sold: 230, revenue: 6897.70 },
                    { product_id: "P003", product_name: "Office Chair", category: "Furniture", price: 299.99, units_sold: 18, revenue: 5399.82 },
                    { product_id: "P004", product_name: "Smartphone", category: "Electronics", price: 699.99, units_sold: 67, revenue: 46899.33 },
                    { product_id: "P005", product_name: "Coffee Maker", category: "Appliances", price: 89.99, units_sold: 92, revenue: 8279.08 }
                ]
            },
            marketingData: {
                id: 'marketingData',
                name: "Marketing Campaign Data",
                description: "Campaign performance metrics",
                icon: 'üìà',
                color: '#6f42c1',
                records: 800,
                features: 9,
                isDefault: true,
                data: [
                    { campaign_id: "C001", channel: "Email", budget: 5000, impressions: 25000, clicks: 1250, conversions: 87, cost_per_click: 4.00 },
                    { campaign_id: "C002", channel: "Social Media", budget: 8000, impressions: 150000, clicks: 3200, conversions: 145, cost_per_click: 2.50 },
                    { campaign_id: "C003", channel: "Search Ads", budget: 12000, impressions: 80000, clicks: 2400, conversions: 210, cost_per_click: 5.00 },
                    { campaign_id: "C004", channel: "Display", budget: 6000, impressions: 200000, clicks: 1800, conversions: 68, cost_per_click: 3.33 },
                    { campaign_id: "C005", channel: "Video", budget: 10000, impressions: 120000, clicks: 2800, conversions: 156, cost_per_click: 3.57 }
                ]
            }
        };

        // All available datasets (defaults + custom)
        let sampleDatasets = { ...defaultDatasets };

        // Node configurations
        const nodeConfigs = {
            // Processing
            dataValidation: { label: 'Data Validation', color: '#ffc107', icon: '‚úÖ' },
            dataCleaning: { label: 'Data Cleaning', color: '#20c997', icon: 'üßπ' },
            featureEngineering: { label: 'Feature Engineering', color: '#6f42c1', icon: 'üîß' },
            dataJoin: { label: 'Data Join', color: '#fd7e14', icon: 'üîó' },
            
            // ML
            modelTraining: { label: 'Model Training', color: '#dc3545', icon: 'üß†' },
            modelEvaluation: { label: 'Model Evaluation', color: '#17a2b8', icon: 'üìà' },
            hyperparameterTuning: { label: 'Hyperparameter Tuning', color: '#e83e8c', icon: '‚öôÔ∏è' },
            
            // Deployment
            modelDeployment: { label: 'Model Deployment', color: '#fd7e14', icon: 'üöÄ' },
            monitoring: { label: 'Model Monitoring', color: '#20c997', icon: 'üìä' },
            alerting: { label: 'Alerting', color: '#dc3545', icon: 'üö®' }
        };

        // Initialize demo
        function initDemo() {
            updateDataSourcePalette();
            updateStats();
            showHelpText("Use the Dataset Manager to add/remove datasets, then drag them to build your ML pipeline!");
            
            // Initialize performance chart
            const ctx = document.getElementById('performanceChart');
            if (ctx) {
                performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Accuracy', 'Precision', 'Recall', 'F1-Score'],
                        datasets: [{
                            label: 'Model Performance',
                            data: [0, 0, 0, 0],
                            borderColor: '#4a90e2',
                            backgroundColor: 'rgba(74, 144, 226, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            setTimeout(() => {
                hideHelpText();
            }, 5000);
        }

        // Dataset Management Functions
        function updateDataSourcePalette() {
            const dataSourcesContainer = document.getElementById('dataSources');
            dataSourcesContainer.innerHTML = '';
            
            Object.values(sampleDatasets).forEach(dataset => {
                const nodeItem = document.createElement('div');
                nodeItem.className = `node-item${dataset.isDefault ? '' : ' custom'}`;
                nodeItem.draggable = true;
                nodeItem.setAttribute('data-node-type', dataset.id);
                
                nodeItem.innerHTML = `
                    <div class="node-icon" style="background: ${dataset.color};">${dataset.icon}</div>
                    <div class="node-info">
                        <h4>${dataset.name}</h4>
                        <p>${dataset.records.toLocaleString()} records - ${dataset.description}</p>
                    </div>
                    ${!dataset.isDefault ? '<button class="node-remove" onclick="removeDataset(\'' + dataset.id + '\')">&times;</button>' : ''}
                `;
                
                dataSourcesContainer.appendChild(nodeItem);
            });
            
            updateStats();
        }

        function showDatasetManager() {
            const modal = document.getElementById('datasetManagerModal');
            const content = document.getElementById('datasetManagerContent');
            
            content.innerHTML = '';
            
            Object.values(sampleDatasets).forEach(dataset => {
                const card = document.createElement('div');
                card.className = 'dataset-card';
                
                const previewData = dataset.data.slice(0, 3);
                const preview = previewData.map(row => 
                    Object.entries(row).slice(0, 3).map(([key, value]) => `${key}: ${value}`).join(', ')
                ).join('\n');
                
                card.innerHTML = `
                    <div class="dataset-header">
                        <div>
                            <div class="dataset-name">${dataset.icon} ${dataset.name}</div>
                            <div class="dataset-stats">${dataset.records.toLocaleString()} records, ${dataset.features} features</div>
                        </div>
                        <div class="dataset-actions">
                            <button class="btn btn-primary" onclick="viewDataset('${dataset.id}')">View</button>
                            ${!dataset.isDefault ? '<button class="btn btn-danger" onclick="removeDataset(\'' + dataset.id + '\')">Remove</button>' : ''}
                        </div>
                    </div>
                    <div class="dataset-preview">${preview}</div>
                `;
                
                content.appendChild(card);
            });
            
            modal.classList.add('show');
        }

        function closeDatasetManager() {
            document.getElementById('datasetManagerModal').classList.remove('show');
        }

        function showAddDatasetModal() {
            closeDatasetManager();
            document.getElementById('addDatasetModal').classList.add('show');
            
            // Setup CSV upload
            const csvUpload = document.getElementById('csvUpload');
            const csvFile = document.getElementById('csvFile');
            
            csvUpload.onclick = () => csvFile.click();
            
            csvUpload.ondragover = (e) => {
                e.preventDefault();
                csvUpload.classList.add('dragover');
            };
            
            csvUpload.ondragleave = () => {
                csvUpload.classList.remove('dragover');
            };
            
            csvUpload.ondrop = (e) => {
                e.preventDefault();
                csvUpload.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleCSVFile(files[0]);
                }
            };
            
            csvFile.onchange = (e) => {
                if (e.target.files.length > 0) {
                    handleCSVFile(e.target.files[0]);
                }
            };
        }

        function closeAddDatasetModal() {
            document.getElementById('addDatasetModal').classList.remove('show');
            // Reset form
            document.getElementById('datasetName').value = '';
            document.getElementById('datasetDescription').value = '';
            document.getElementById('datasetIcon').value = '';
            document.getElementById('datasetJson').value = '';
        }

        function toggleDataInput() {
            const method = document.getElementById('dataInputMethod').value;
            document.getElementById('jsonInput').style.display = method === 'json' ? 'block' : 'none';
            document.getElementById('csvInput').style.display = method === 'csv' ? 'block' : 'none';
            document.getElementById('generateInput').style.display = method === 'generate' ? 'block' : 'none';
        }

        function handleCSVFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const data = [];
                for (let i = 1; i < Math.min(lines.length, 21); i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        data.push(row);
                    }
                }
                
                document.getElementById('datasetJson').value = JSON.stringify(data, null, 2);
                
                if (!document.getElementById('datasetName').value) {
                    document.getElementById('datasetName').value = file.name.replace('.csv', '');
                }
            };
            reader.readAsText(file);
        }

        function generateSampleData(type, count) {
            const generators = {
                customers: () => ({
                    id: Math.floor(Math.random() * 10000),
                    name: ['John Doe', 'Jane Smith', 'Bob Johnson', 'Alice Brown', 'Charlie Wilson'][Math.floor(Math.random() * 5)],
                    age: Math.floor(Math.random() * 50) + 20,
                    income: Math.floor(Math.random() * 80000) + 30000,
                    city: ['New York', 'Chicago', 'San Francisco', 'Austin', 'Denver'][Math.floor(Math.random() * 5)],
                    segment: ['Basic', 'Standard', 'Premium'][Math.floor(Math.random() * 3)]
                }),
                sales: () => ({
                    transaction_id: 'T' + Math.floor(Math.random() * 100000),
                    product: ['Laptop', 'Phone', 'Tablet', 'Headphones', 'Mouse'][Math.floor(Math.random() * 5)],
                    amount: Math.floor(Math.random() * 2000) + 50,
                    quantity: Math.floor(Math.random() * 5) + 1,
                    date: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                }),
                products: () => ({
                    product_id: 'P' + Math.floor(Math.random() * 1000),
                    name: ['Product A', 'Product B', 'Product C', 'Product D'][Math.floor(Math.random() * 4)],
                    category: ['Electronics', 'Clothing', 'Home', 'Books'][Math.floor(Math.random() * 4)],
                    price: Math.floor(Math.random() * 500) + 10,
                    stock: Math.floor(Math.random() * 100)
                }),
                users: () => ({
                    user_id: Math.floor(Math.random() * 10000),
                    sessions: Math.floor(Math.random() * 50) + 1,
                    page_views: Math.floor(Math.random() * 200) + 5,
                    time_on_site: Math.floor(Math.random() * 3600) + 60,
                    bounce_rate: Math.random().toFixed(2)
                })
            };
            
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push(generators[type]());
            }
            return data;
        }

        function createDataset() {
            const name = document.getElementById('datasetName').value.trim();
            const description = document.getElementById('datasetDescription').value.trim();
            const icon = document.getElementById('datasetIcon').value.trim() || 'üìä';
            const color = document.getElementById('datasetColor').value;
            const method = document.getElementById('dataInputMethod').value;
            
            if (!name) {
                showHelpText('Please enter a dataset name!');
                setTimeout(hideHelpText, 3000);
                return;
            }
            
            let data = [];
            
            try {
                if (method === 'json') {
                    const jsonText = document.getElementById('datasetJson').value.trim();
                    if (!jsonText) {
                        showHelpText('Please enter JSON data!');
                        setTimeout(hideHelpText, 3000);
                        return;
                    }
                    data = JSON.parse(jsonText);
                } else if (method === 'generate') {
                    const sampleType = document.getElementById('sampleDataType').value;
                    const recordCount = parseInt(document.getElementById('sampleRecordCount').value);
                    data = generateSampleData(sampleType, recordCount);
                } else {
                    const jsonText = document.getElementById('datasetJson').value.trim();
                    if (!jsonText) {
                        showHelpText('Please upload a CSV file or enter JSON data!');
                        setTimeout(hideHelpText, 3000);
                        return;
                    }
                    data = JSON.parse(jsonText);
                }
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('Data must be a non-empty array');
                }
                
                const datasetId = 'custom_' + Date.now();
                const features = Object.keys(data[0]).length;
                
                const newDataset = {
                    id: datasetId,
                    name: name,
                    description: description,
                    icon: icon,
                    color: color,
                    records: data.length,
                    features: features,
                    isDefault: false,
                    data: data
                };
                
                sampleDatasets[datasetId] = newDataset;
                
                // Add to node configs
                nodeConfigs[datasetId] = {
                    label: name,
                    color: color,
                    icon: icon,
                    hasData: true
                };
                
                updateDataSourcePalette();
                closeAddDatasetModal();
                
                showHelpText(`Dataset "${name}" created successfully with ${data.length} records!`);
                setTimeout(hideHelpText, 3000);
                
            } catch (error) {
                showHelpText('Error creating dataset: ' + error.message);
                setTimeout(hideHelpText, 3000);
            }
        }

        function removeDataset(datasetId) {
            if (sampleDatasets[datasetId] && !sampleDatasets[datasetId].isDefault) {
                delete sampleDatasets[datasetId];
                delete nodeConfigs[datasetId];
                updateDataSourcePalette();
                closeDatasetManager();
                
                showHelpText('Dataset removed successfully!');
                setTimeout(hideHelpText, 2000);
            }
        }

        function viewDataset(datasetId) {
            const dataset = sampleDatasets[datasetId];
            if (dataset) {
                currentDataset = dataset;
                updateDataVisualization();
                closeDatasetManager();
                showDataModal();
            }
        }

        function loadDefaultDatasets() {
            sampleDatasets = { ...defaultDatasets };
            
            // Reset node configs for data sources
            Object.keys(nodeConfigs).forEach(key => {
                if (nodeConfigs[key].hasData && !defaultDatasets[key]) {
                    delete nodeConfigs[key];
                }
            });
            
            // Add default configs
            Object.keys(defaultDatasets).forEach(key => {
                const dataset = defaultDatasets[key];
                nodeConfigs[key] = {
                    label: dataset.name,
                    color: dataset.color,
                    icon: dataset.icon,
                    hasData: true
                };
            });
            
            updateDataSourcePalette();
            closeDatasetManager();
            
            showHelpText('Default datasets restored!');
            setTimeout(hideHelpText, 2000);
        }

        // Rest of the functions (same as previous version)
        function loadSamplePipeline() {
            clearAll();
            
            const pipelineNodes = [
                { id: 'node_1', type: 'fraudData', title: 'Fraud Detection Dataset', x: 50, y: 50, status: 'ready' },
                { id: 'node_2', type: 'dataValidation', title: 'Validate Data Quality', x: 350, y: 50, status: 'idle' },
                { id: 'node_3', type: 'dataCleaning', title: 'Clean & Preprocess', x: 650, y: 50, status: 'idle' },
                { id: 'node_4', type: 'featureEngineering', title: 'Engineer Features', x: 950, y: 50, status: 'idle' },
                { id: 'node_5', type: 'modelTraining', title: 'Train Random Forest', x: 350, y: 250, status: 'idle' },
                { id: 'node_6', type: 'modelEvaluation', title: 'Evaluate Performance', x: 650, y: 250, status: 'idle' },
                { id: 'node_7', type: 'modelDeployment', title: 'Deploy to Production', x: 950, y: 250, status: 'idle' },
                { id: 'node_8', type: 'monitoring', title: 'Monitor Performance', x: 650, y: 450, status: 'idle' }
            ];

            pipelineNodes.forEach(node => {
                nodes.push(node);
                createNodeElement(node);
            });

            const pipelineConnections = [
                { id: 'conn_1', source: 'node_1', target: 'node_2' },
                { id: 'conn_2', source: 'node_2', target: 'node_3' },
                { id: 'conn_3', source: 'node_3', target: 'node_4' },
                { id: 'conn_4', source: 'node_4', target: 'node_5' },
                { id: 'conn_5', source: 'node_5', target: 'node_6' },
                { id: 'conn_6', source: 'node_6', target: 'node_7' },
                { id: 'conn_7', source: 'node_7', target: 'node_8' }
            ];

            connections.push(...pipelineConnections);
            drawConnections();
            updateStats();
            
            currentDataset = sampleDatasets.fraudData;
            updateDataVisualization();
            
            showHelpText("Sample pipeline loaded! Click 'Execute Pipeline' to see the full ML process in action.");
            setTimeout(hideHelpText, 4000);
        }

        function createNodeElement(node) {
            const nodeEl = document.createElement('div');
            nodeEl.className = 'workflow-node';
            nodeEl.id = node.id;
            nodeEl.style.left = node.x + 'px';
            nodeEl.style.top = node.y + 'px';
            nodeEl.setAttribute('data-node-type', node.type);
            
            const config = nodeConfigs[node.type];
            
            let nodeBody = '';
            if (config.hasData && sampleDatasets[node.type]) {
                const dataset = sampleDatasets[node.type];
                nodeBody = `
                    <div class="node-body">
                        <strong>${dataset.name}</strong><br>
                        üìä ${dataset.records.toLocaleString()} records, ${dataset.features} features
                        <div class="node-preview">
                            <div class="data-preview">
                                ${dataset.data.slice(0, 3).map(row => `
                                    <div class="data-row">${Object.keys(row).slice(0, 3).map(key => `${key}: ${row[key]}`).join(', ')}</div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else if (node.status === 'completed' && node.results) {
                nodeBody = `
                    <div class="node-body">
                        <strong>Results:</strong><br>
                        ${node.results}
                    </div>
                `;
            }
            
            nodeEl.innerHTML = `
                <div class="connection-handle input-handle" data-handle-type="input" data-node-id="${node.id}"></div>
                <div class="node-header">
                    <div class="node-icon" style="background: ${config.color};">${config.icon}</div>
                    <div class="node-content">
                        <div class="node-title">${node.title}</div>
                        <div class="node-type">${config.label}</div>
                    </div>
                </div>
                <div class="node-status ${node.status || 'idle'}"></div>
                <div class="connection-handle output-handle" data-handle-type="output" data-node-id="${node.id}"></div>
                ${nodeBody}
            `;
            
            makeNodeDraggable(nodeEl);
            nodeEl.addEventListener('click', (e) => {
                e.stopPropagation();
                selectNode(node.id);
            });
            
            const outputHandle = nodeEl.querySelector('.output-handle');
            const inputHandle = nodeEl.querySelector('.input-handle');
            
            outputHandle.addEventListener('mousedown', startConnection);
            inputHandle.addEventListener('mouseup', endConnection);
            inputHandle.addEventListener('mouseenter', highlightHandle);
            inputHandle.addEventListener('mouseleave', unhighlightHandle);
            
            document.getElementById('canvas').appendChild(nodeEl);
        }

        function updateDataVisualization() {
            if (!currentDataset) return;
            
            document.getElementById('recordCount').textContent = currentDataset.records.toLocaleString();
            document.getElementById('featureCount').textContent = currentDataset.features;
            
            const preview = document.getElementById('dataPreview');
            if (currentDataset.data && currentDataset.data.length > 0) {
                const sampleData = currentDataset.data.slice(0, 5);
                preview.innerHTML = `
                    <strong>${currentDataset.name}</strong><br><br>
                    ${sampleData.map(row => `
                        <div style="margin-bottom: 0.5rem; padding: 0.25rem; background: white; border-radius: 3px;">
                            ${Object.entries(row).slice(0, 4).map(([key, value]) => `<span style="margin-right: 1rem;"><strong>${key}:</strong> ${value}</span>`).join('')}
                        </div>
                    `).join('')}
                `;
            }
        }

        function selectNode(nodeId) {
            document.querySelectorAll('.workflow-node').forEach(node => {
                node.classList.remove('selected');
            });
            
            selectedNode = nodeId;
            const nodeEl = document.getElementById(nodeId);
            nodeEl.classList.add('selected');
            
            const node = nodes.find(n => n.id === nodeId);
            if (node && nodeConfigs[node.type].hasData && sampleDatasets[node.type]) {
                currentDataset = sampleDatasets[node.type];
                updateDataVisualization();
            }
            
            updateStats();
        }

        function showDataModal() {
            if (!currentDataset) {
                showHelpText("Select a data source node first to view its dataset!");
                setTimeout(hideHelpText, 3000);
                return;
            }
            
            const modal = document.getElementById('dataModal');
            const content = document.getElementById('modalDataContent');
            
            const headers = Object.keys(currentDataset.data[0]);
            
            content.innerHTML = `
                <h4>${currentDataset.name}</h4>
                <p>Total Records: ${currentDataset.records.toLocaleString()} | Features: ${currentDataset.features}</p>
                <table class="data-table">
                    <thead>
                        <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        ${currentDataset.data.slice(0, 20).map(row => `
                            <tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="margin-top: 1rem; font-size: 0.875rem; color: #666;">
                    Showing first 20 records of ${currentDataset.records.toLocaleString()} total records
                </p>
            `;
            
            modal.classList.add('show');
        }

        function closeDataModal() {
            document.getElementById('dataModal').classList.remove('show');
        }

        function updateStats() {
            document.getElementById('nodeCount').textContent = nodes.length;
            document.getElementById('connectionCount').textContent = connections.length;
            document.getElementById('datasetCount').textContent = Object.keys(sampleDatasets).length;
        }

        function showHelpText(message) {
            const helpText = document.getElementById('helpText');
            helpText.textContent = message;
            helpText.classList.add('show');
        }

        function hideHelpText() {
            const helpText = document.getElementById('helpText');
            helpText.classList.remove('show');
        }

        function clearAll() {
            nodes = [];
            connections = [];
            selectedNode = null;
            nodeCounter = 0;
            currentDataset = null;
            
            document.getElementById('canvas').innerHTML = `
                <svg id="connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#4a90e2" />
                        </marker>
                    </defs>
                </svg>
            `;
            
            updateStats();
            updateDataVisualization();
            
            if (performanceChart) {
                performanceChart.data.datasets[0].data = [0, 0, 0, 0];
                performanceChart.update();
            }
            
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('pipelineProgress').textContent = '0%';
            document.getElementById('executionLog').innerHTML = 'Ready to execute pipeline...';
            document.getElementById('dataPreview').innerHTML = 'Select a data source to preview...';
            document.getElementById('recordCount').textContent = '-';
            document.getElementById('featureCount').textContent = '-';
            
            showHelpText("Canvas cleared! Use Dataset Manager to add/remove data sources or load a sample pipeline.");
            setTimeout(hideHelpText, 3000);
        }

        // Include all connection and execution functions from previous version
        function executeWorkflow() {
            if (executionInProgress) return;
            if (nodes.length === 0) {
                showHelpText("Add some nodes first, or click 'Load Sample Pipeline'!");
                setTimeout(hideHelpText, 3000);
                return;
            }
            
            executionInProgress = true;
            const executionStatus = document.getElementById('executionStatus');
            const executionText = document.getElementById('executionText');
            const progressFill = document.getElementById('progressFill');
            const executionLog = document.getElementById('executionLog');
            
            executionStatus.className = 'execution-dot running';
            executionText.textContent = 'Executing Pipeline...';
            
            executionLog.innerHTML = '';
            
            let currentStep = 0;
            const totalSteps = nodes.length;
            
            function executeNextStep() {
                if (currentStep >= totalSteps) {
                    executionStatus.className = 'execution-dot';
                    executionText.textContent = 'Pipeline Completed!';
                    progressFill.style.width = '100%';
                    
                    if (performanceChart) {
                        performanceChart.data.datasets[0].data = [0.89, 0.85, 0.91, 0.88];
                        performanceChart.update();
                    }
                    
                    appendLog('‚úÖ Pipeline execution completed successfully!');
                    appendLog('üìä Final Results: Accuracy: 89%, Precision: 85%, Recall: 91%, F1-Score: 88%');
                    
                    executionInProgress = false;
                    
                    setTimeout(() => {
                        executionText.textContent = 'Ready';
                        document.getElementById('pipelineProgress').textContent = '100%';
                    }, 3000);
                    
                    return;
                }
                
                const node = nodes[currentStep];
                const nodeEl = document.getElementById(node.id);
                
                updateNodeStatus(node.id, 'running');
                nodeEl.classList.add('executing');
                
                const progress = ((currentStep + 1) / totalSteps) * 100;
                progressFill.style.width = progress + '%';
                document.getElementById('pipelineProgress').textContent = Math.round(progress) + '%';
                
                const config = nodeConfigs[node.type];
                let processingTime = 2000;
                let logMessage = `‚ö° Processing: ${node.title}`;
                let results = '';
                
                if (config.hasData) {
                    const dataset = sampleDatasets[node.type];
                    logMessage = `üìä Loading data from ${config.label}...`;
                    results = `Loaded ${dataset.records.toLocaleString()} records`;
                    processingTime = 1500;
                } else {
                    switch (node.type) {
                        case 'dataValidation':
                            logMessage = '‚úÖ Validating data quality...';
                            results = 'Data validation passed: 0 missing values, 0 duplicates';
                            break;
                        case 'dataCleaning':
                            logMessage = 'üßπ Cleaning and preprocessing data...';
                            results = 'Cleaned 1,000 records, standardized features';
                            break;
                        case 'featureEngineering':
                            logMessage = 'üîß Engineering features...';
                            results = 'Created 12 new features, scaled numerical data';
                            break;
                        case 'modelTraining':
                            logMessage = 'üß† Training machine learning model...';
                            results = 'Random Forest trained: 100 trees, 89% accuracy';
                            processingTime = 3000;
                            break;
                        case 'modelEvaluation':
                            logMessage = 'üìà Evaluating model performance...';
                            results = 'Accuracy: 89%, Precision: 85%, Recall: 91%';
                            break;
                        case 'modelDeployment':
                            logMessage = 'üöÄ Deploying model to production...';
                            results = 'Model deployed to endpoint: /api/v1/predict';
                            break;
                        case 'monitoring':
                            logMessage = 'üìä Setting up monitoring...';
                            results = 'Monitoring active: drift detection enabled';
                            break;
                    }
                }
                
                appendLog(logMessage);
                
                const outgoingConnections = connections.filter(c => c.source === node.id);
                outgoingConnections.forEach(conn => {
                    const connectionEl = document.querySelector(`[data-connection-id="${conn.id}"]`);
                    if (connectionEl) {
                        connectionEl.classList.add('active');
                    }
                });
                
                setTimeout(() => {
                    updateNodeStatus(node.id, 'completed');
                    nodeEl.classList.remove('executing');
                    
                    node.results = results;
                    updateNodeResults(node.id, results);
                    
                    appendLog(`‚úÖ ${node.title} completed: ${results}`);
                    
                    outgoingConnections.forEach(conn => {
                        const connectionEl = document.querySelector(`[data-connection-id="${conn.id}"]`);
                        if (connectionEl) {
                            connectionEl.classList.remove('active');
                        }
                    });
                    
                    currentStep++;
                    executeNextStep();
                }, processingTime);
            }
            
            executeNextStep();
        }

        function appendLog(message) {
            const log = document.getElementById('executionLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function updateNodeStatus(nodeId, status) {
            const node = nodes.find(n => n.id === nodeId);
            if (node) {
                node.status = status;
                const nodeEl = document.getElementById(nodeId);
                const statusEl = nodeEl.querySelector('.node-status');
                statusEl.className = `node-status ${status}`;
            }
        }

        function updateNodeResults(nodeId, results) {
            const nodeEl = document.getElementById(nodeId);
            let bodyEl = nodeEl.querySelector('.node-body');
            
            if (!bodyEl) {
                bodyEl = document.createElement('div');
                bodyEl.className = 'node-body';
                nodeEl.appendChild(bodyEl);
            }
            
            bodyEl.innerHTML = `<strong>Results:</strong><br>${results}`;
        }

        function saveWorkflow() {
            const executionStatus = document.getElementById('executionStatus');
            const executionText = document.getElementById('executionText');
            
            executionStatus.className = 'execution-dot';
            executionText.textContent = 'Saved';
            
            setTimeout(() => {
                executionText.textContent = 'Ready';
            }, 2000);
            
            console.log('Workflow saved:', { nodes, connections });
            showHelpText('Workflow saved successfully!');
            setTimeout(hideHelpText, 2000);
        }

        // Include all drag/drop and connection functions from previous version
        function makeNodeDraggable(nodeEl) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            nodeEl.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('connection-handle')) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = parseInt(nodeEl.style.left);
                initialY = parseInt(nodeEl.style.top);
                
                nodeEl.style.zIndex = '100';
                document.addEventListener('mousemove', dragNode);
                document.addEventListener('mouseup', stopDragNode);
            });

            function dragNode(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                nodeEl.style.left = (initialX + deltaX) + 'px';
                nodeEl.style.top = (initialY + deltaY) + 'px';
                
                const node = nodes.find(n => n.id === nodeEl.id);
                if (node) {
                    node.x = initialX + deltaX;
                    node.y = initialY + deltaY;
                }
                
                drawConnections();
            }

            function stopDragNode() {
                isDragging = false;
                nodeEl.style.zIndex = '10';
                document.removeEventListener('mousemove', dragNode);
                document.removeEventListener('mouseup', stopDragNode);
            }
        }

        function startConnection(e) {
            e.stopPropagation();
            e.preventDefault();
            
            isConnecting = true;
            connectionStart = {
                nodeId: e.target.getAttribute('data-node-id'),
                handle: 'output'
            };
            
            document.getElementById('canvas').style.background = 'rgba(255, 193, 7, 0.1)';
            document.addEventListener('mousemove', drawTempConnection);
            document.addEventListener('mouseup', cancelConnection);
            
            showHelpText('Drag to an input handle (left side) to create connection');
        }

        function endConnection(e) {
            if (!isConnecting) return;
            
            e.stopPropagation();
            e.preventDefault();
            
            const targetNodeId = e.target.getAttribute('data-node-id');
            
            if (connectionStart && targetNodeId !== connectionStart.nodeId) {
                const newConnection = {
                    id: `conn_${Date.now()}`,
                    source: connectionStart.nodeId,
                    target: targetNodeId
                };
                
                const existingConnection = connections.find(
                    c => c.source === newConnection.source && c.target === newConnection.target
                );
                
                if (!existingConnection) {
                    connections.push(newConnection);
                    updateStats();
                    showHelpText('Connection created!');
                    setTimeout(hideHelpText, 2000);
                }
            }
            
            cancelConnection();
        }

        function cancelConnection() {
            isConnecting = false;
            connectionStart = null;
            
            document.getElementById('canvas').style.background = '';
            document.removeEventListener('mousemove', drawTempConnection);
            document.removeEventListener('mouseup', cancelConnection);
            
            const tempPath = document.querySelector('.connection-line.temp');
            if (tempPath) {
                tempPath.remove();
            }
        }

        function drawTempConnection(e) {
            if (!connectionStart) return;
            
            const canvas = document.getElementById('canvas');
            const canvasRect = canvas.getBoundingClientRect();
            const sourceNode = document.getElementById(connectionStart.nodeId);
            const sourceRect = sourceNode.getBoundingClientRect();
            
            const startX = sourceRect.right - canvasRect.left;
            const startY = sourceRect.top + sourceRect.height / 2 - canvasRect.top;
            const endX = e.clientX - canvasRect.left;
            const endY = e.clientY - canvasRect.top;
            
            const tempPath = document.querySelector('.connection-line.temp');
            if (tempPath) {
                tempPath.remove();
            }
            
            const svg = document.getElementById('connections');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const controlPointOffset = Math.min(Math.abs(endX - startX) * 0.5, 100);
            const d = `M ${startX} ${startY} C ${startX + controlPointOffset} ${startY} ${endX - controlPointOffset} ${endY} ${endX} ${endY}`;
            
            path.setAttribute('d', d);
            path.setAttribute('class', 'connection-line temp');
            svg.appendChild(path);
        }

        function highlightHandle(e) {
            if (isConnecting && connectionStart) {
                e.target.classList.add('highlight');
            }
        }

        function unhighlightHandle(e) {
            e.target.classList.remove('highlight');
        }

        function drawConnections() {
            const svg = document.getElementById('connections');
            
            const existingPaths = svg.querySelectorAll('.connection-line:not(.temp)');
            existingPaths.forEach(path => path.remove());

            connections.forEach(conn => {
                const sourceNode = document.getElementById(conn.source);
                const targetNode = document.getElementById(conn.target);
                
                if (sourceNode && targetNode) {
                    const sourceRect = sourceNode.getBoundingClientRect();
                    const targetRect = targetNode.getBoundingClientRect();
                    const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                    
                    const startX = sourceRect.right - canvasRect.left;
                    const startY = sourceRect.top + sourceRect.height / 2 - canvasRect.top;
                    const endX = targetRect.left - canvasRect.left;
                    const endY = targetRect.top + targetRect.height / 2 - canvasRect.top;
                    
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const controlPointOffset = Math.min(Math.abs(endX - startX) * 0.5, 100);
                    const d = `M ${startX} ${startY} C ${startX + controlPointOffset} ${startY} ${endX - controlPointOffset} ${endY} ${endX} ${endY}`;
                    
                    path.setAttribute('d', d);
                    path.setAttribute('class', 'connection-line');
                    path.setAttribute('data-connection-id', conn.id);
                    
                    path.addEventListener('click', () => deleteConnection(conn.id));
                    path.style.pointerEvents = 'stroke';
                    path.style.strokeWidth = '10';
                    path.style.stroke = 'transparent';
                    
                    const visiblePath = path.cloneNode();
                    visiblePath.style.pointerEvents = 'none';
                    visiblePath.style.strokeWidth = '2';
                    visiblePath.style.stroke = '#4a90e2';
                    
                    svg.appendChild(path);
                    svg.appendChild(visiblePath);
                }
            });
        }

        function deleteConnection(connectionId) {
            connections = connections.filter(c => c.id !== connectionId);
            drawConnections();
            updateStats();
            showHelpText('Connection deleted');
            setTimeout(hideHelpText, 2000);
        }

        // Drag and drop functionality
        document.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('node-item')) {
                e.dataTransfer.setData('text/plain', e.target.getAttribute('data-node-type'));
            }
        });

        document.getElementById('canvas').addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        document.getElementById('canvas').addEventListener('drop', (e) => {
            e.preventDefault();
            const nodeType = e.dataTransfer.getData('text/plain');
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left - 120;
            const y = e.clientY - rect.top - 40;
            
            const config = nodeConfigs[nodeType];
            const newNode = {
                id: `node_${++nodeCounter + 100}`,
                type: nodeType,
                title: `${config.label}`,
                x: Math.max(0, x),
                y: Math.max(0, y),
                status: config.hasData ? 'ready' : 'idle'
            };
            
            nodes.push(newNode);
            createNodeElement(newNode);
            updateStats();
            
            if (config.hasData) {
                selectNode(newNode.id);
            }
            
            showHelpText(`${config.label} added! ${config.hasData ? 'Data loaded and ready.' : 'Connect to other nodes to build your pipeline.'}`);
            setTimeout(hideHelpText, 3000);
        });

        // Clear selection when clicking on canvas
        document.getElementById('canvas').addEventListener('click', (e) => {
            if (e.target.id === 'canvas') {
                selectedNode = null;
                document.querySelectorAll('.workflow-node').forEach(node => {
                    node.classList.remove('selected');
                });
                updateStats();
            }
        });

        // Initialize the demo
        window.addEventListener('load', initDemo);
        window.addEventListener('resize', drawConnections);
    </script>
</body>
</html>